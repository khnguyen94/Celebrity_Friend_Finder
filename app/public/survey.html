<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>

    <!-- Link CSS Reset -->
    <link rel="stylesheet" href="../css/reset.css">
    <!-- Link JQuery CDN -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <!-- Link Bootstrap CDN -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <!-- Link Custom CSS -->
    <link rel="stylesheet" type="text/css" href="../css/style.css">
  </head>

  <body>
    <div class="container">
      <div class="jumbotron">
        <h1>Celebrity Friend Finder</h1>

        <br />

        <form method="POST" role="form">
          <!-- Ask for basic user data -->
          <h3>Tell us a bit about yourself.</h3>

          <div class="form-group">
            <label for="userNameInput">Name</label>
            <input type="text" class="form-control" id="userNameInput" />
          </div>

          <div class="form-group">
            <label for="userEmailInput"> Email Address </label>
            <input
              type="email"
              class="form-control"
              id="userEmailInput"
              aria-describedby="emailHelp"
              placeholder="Enter email"
            />
            <small id="emailHelp" class="form-text text-muted"
              >We'll never share your email with anyone else.</small
            >
          </div>

          <div class="form-group">
            <label for="exampleFormControlTextarea1"
              >Link a profile image
            </label>
            <textarea
              class="form-control"
              id="userImageLinkInput"
              rows="1"
            ></textarea>
          </div>
        </form>

        <br />

        <!-- Ask survey questions -->
        <div class="form-group">
          <h5>Question 1</h5>
          <label for="question1">You are self-asborbed.</label>
          <select class="form-control" id="q1">
            <option value="0">Select</option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
          </select>
        </div>

        <div class="form-group">
          <h5>Question 2</h5>
          <label for="question2"
            >You care about your physical appearance.</label
          >
          <select class="form-control" id="q2">
            <option value="0">Select</option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
          </select>
        </div>

        <div class="form-group">
          <h5>Question 3</h5>
          <label for="question3"
            >You think you have an impeccable sense of humor.</label
          >
          <select class="form-control" id="q3">
            <option value="0">Select</option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
          </select>
        </div>

        <div class="form-group">
          <h5>Question 4</h5>
          <label for="question4">You are entreprenurial.</label>
          <select class="form-control" id="q4">
            <option value="0">Select</option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
          </select>
        </div>

        <div class="form-group">
          <h5>Question 5</h5>
          <label for="question5">You are vain.</label>
          <select class="form-control" id="q5">
            <option value="0">Select</option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
          </select>
        </div>

        <div class="form-group">
          <h5>Question 6</h5>
          <label for="question6"
            >You spend a lot of time in the limelight.</label
          >
          <select class="form-control" id="q6">
            <option value="0">Select</option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
          </select>
        </div>

        <div class="form-group">
          <h5>Question 7</h5>
          <label for="question7"
            >You are humble about your accomplishments.</label
          >
          <select class="form-control" id="q7">
            <option value="0">Select</option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
          </select>
        </div>

        <div class="form-group">
          <h5>Question 8</h5>
          <label for="question8">You are musically gifted.</label>
          <select class="form-control" id="q8">
            <option value="0">Select</option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
          </select>
        </div>

        <div class="form-group">
          <h5>Question 9</h5>
          <label for="question9"
            >You have a knack for theatre and acting.</label
          >
          <select class="form-control" id="q9">
            <option value="0">Select</option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
          </select>
        </div>

        <div class="form-group">
          <h5>Question 10</h5>
          <label for="question10">Money is everything in life.</label>
          <select class="form-control" id="q10">
            <option value="0">Select</option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
          </select>
        </div>

        <br />

        <!-- Submit button -->
        <div>
          <button
            type="submit"
            id="submit-survey-button"
            class="btn btn-primary btn-lg"
          >
            Submit Survey
          </button>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div
      id="matched-modal"
      class="modal fade"
      tabindex="-1"
      role="dialog"
      aria-labelledby="exampleModalCenterTitle"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              You've Matched with A Celeb! -
              <span id="matched-name-display"></span>
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <img id="matched-photo-display" src="" alt=""/>
            <p id="matched-info-display">Compatibility Score:</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

<!-- JS logic to handle submit data -->
<script type="text/javascript">
  // Create an array to hold all celebs
  var celebArr = [];

  // When the html document is fully loaded run a anon function for the JS
  $(document).ready(function() {
    // Use and ajax command to call on all the celebs
    $.ajax({
      url: "/api/friends",
      method: "GET"
    }).then(function(data) {
      // console.log(data);
      // Assign the data to the celebs array
      celebArr = data;
    });

    console.log(celebArr);

    // Create on-click logic for submit button
    $("#submit-survey-button").on("click", function(event) {
      // Prevent refresh
      event.preventDefault();

      if (!$(".form-control")) {
        alert("There are empty fields of the form!");
      } else {
        // Grabs all the inputs and creates an object using all of these inputs
        // Grab the name of the new Friend
        newFriendName = $("#userNameInput")
          .val()
          .trim();

        // Create a route name from this name for the new Friend
        newFriendRouteName = newFriendName.replace(/\s+/g, "").toLowerCase();

        // Create an empty array to hold new Friend survey answers
        var userSurveyAnswers = [];

        // Use a for loop to push all the user survey question field values to the userScoresArr
        for (var i = 1; i < 11; i++) {
          // Get a jquery handle on the current html form value
          var questionAnswer = $("#q" + i)
            .val()
            .trim();

          // convert questionAnswer to integer
          questionAnswer = parseInt(questionAnswer);

          // Push value to the userScoresArr
          userSurveyAnswers.push(questionAnswer);
        }

        // Check both score
        // console.log(userSurveyAnswers);

        // Grab the rest of the form elements to be used in creating a new user
        var newFriend = {
          routeName: newFriendRouteName,
          name: newFriendName,
          email: $("#userImageEmailLinkInput").val(),
          photo: $("#userImageLinkInput").val(),
          type: "friend",
          scores: userSurveyAnswers
        };

        // Create an post command that takes in the destination URL, the new friend object we are sending, then runa callback function that will execute a response from the server
        // In the api-routes POST, there should be logic that matches the user with a friend and return it back as the data
        // Data is a variable that the callback function should receive form the server, it is the match celeb friend
        $.post("/api/friends", newFriend, function(data) {
          if (data) {
            console.log("The user has been posted");
          } else {
            alert(
              "Sorry, there was an issue adding your survey. Please reload and try again!"
            );
          }

          // Clear the form after submitting
          $("#userNameInput").val("");
          $("#userEmailInput").val("");
          $("#userImageLinkInput").val("");
          $("#q1").val("");
          $("#q2").val("");
          $("#q3").val("");
          $("#q4").val("");
          $("#q5").val("");
          $("#q6").val("");
          $("#q7").val("");
          $("#q8").val("");
          $("#q9").val("");
          $("#q10").val("");
        });

        // Matching Logic Here
        // Create a variable to hold the array of celebrity scores
        var celebScoresArr = [];

        // Create a variable to hold the single array of the newFriend's scores
        var newFriendScoresArr = [];

        // Create a variable to hold the array of combatibility scores (post calculations with the newFriend's data)
        var compatScoresArr = [];

        // Pull all the scores data from friends and push to the celebScoresArr, use a for loop
        for (var i = 0; i < celebArr.length - 1; i++) {
          // Create individual array to hold the i'th celeb's scores
          celebScore = [];

          // Assign the new individual array to the the one at the i'th count
          celebScore = celebArr[i].scores;

          // Push the new individual array into celebScoresArr
          celebScoresArr.push(celebScore);
        }

        // Pull the newFriend's scores into the newFriendScoresArr
        newFriendScoresArr = newFriend.scores;

        console.log("celebs ");
        console.log(celebScoresArr);

        console.log("new friend ");
        console.log(newFriendScoresArr);

        // Create a function that calculates all the differences in scores between celebScoresArr and  newFriendScoresArr
        // Push all the new arrays to compatScoresArr
        function calculateDifferences(celebArr, friendArr, resultsArr) {
          // Loop through each celeb scores array and calculate the difference between that array and the friend's score array
          for (var i = 0; i < celebArr.length; i++) {
            // Create an empty array to hold the difference of the i'th celeb scores and the friend's scores
            var diffArr = [];

            // Create a nested for loop to loop through each number of the i'th celeb's scores
            for (var j = 0; j < celebArr[i].length; j++) {
              // Create a variable to hold the difference number
              var diffNum;

              // Calculat the difference between the two numbers at the matching j'th index
              diffNum = celebArr[i][j] - parseInt(friendArr[j]);

              // Calculate the difference
              diffNum = Math.abs(diffNum);

              // Push that difference to the diffArr
              diffArr.push(diffNum);
            }
            // Push that diffArr to resultsArr
            resultsArr.push(diffArr);
          }
        }

        // Run the calculateDifferences function, pass in all 3 arrays
        calculateDifferences(
          celebScoresArr,
          newFriendScoresArr,
          compatScoresArr
        );

        console.log("compat arr");
        console.log(compatScoresArr);

        // Create a variable to hold all the sums of differences of each differenceArray
        var sumDiffArr = [];

        // Create a function that will calculate the total sum of each difference array in compatScoresArr
        function calculateSumOfArr(compatArrays, resultsArr) {
          // Use a forloop to loop through every sub array in compatArrays
          for (var i = 0; i < compatArrays.length; i++) {
            // Create a variable to hold sum of the array
            var arraySum = 0;

            // Loop through each sub array and calculate the sum
            for (var j = 0; j < compatArrays[i].length; j++) {
              // Recursively add each value to arraySum
              arraySum += parseInt(compatArrays[i][j]);
            }

            // Push arraySum into sumDiffArr
            resultsArr.push(arraySum);
          }
        }

        // Run the calculateSumDiff function and pass through compatScoresArr
        calculateSumOfArr(compatScoresArr, sumDiffArr);

        console.log("sumDiffArr");
        console.log(sumDiffArr);

        // Create a variable to hold lowest sum
        var lowestSum;

        // Create a variable to hold lowest sum's index
        var lowestSumIndex;

        // Create a function that gets the index of of the lowest difference in sumDiffArr
        function getLowestIndex(sumArr) {
          // Find the lowest num and assign it to lowestNum
          lowestSum = Math.min(...sumArr);

          console.log(lowestSum);

          // Assign the index of the lowest value number in the array to lowestIndex
          lowestSumIndex = sumArr.indexOf(lowestSum);
        }

        // Run the getLowestIndex, pass through sumDiffArr
        getLowestIndex(sumDiffArr);

        console.log("lowestSumIndex");
        console.log(lowestSumIndex);

        // Create a variable to hold the match celeb friend
        var matchedCelebFriend;

        // Create a function that returns the celeb object at the index to be sent back to the user for processing
        function findMatchedCeleb(indexNum) {
          // Access friends and assign matchedCelebFriend to the celeb at that index
          matchedCelebFriend = celebArr[indexNum];
        }

        // Run findMatchedCeleb, pass through lowestSumIndex
        findMatchedCeleb(lowestSumIndex);

        console.log("matchedCelebFriend");
        console.log(matchedCelebFriend);
        console.log(matchedCelebFriend.photo);

        // Create a new variable to hold matchedCelebFriend's name
        var matchCelebName;

        // Set it
        matchCelebName = matchedCelebFriend.routeName;

        // console.log(matchCelebName);

        // Create a function to render the modal with all the information
        function renderModal(matchedCeleb) {
          // Display the modal
          $("#matched-modal").modal("show");

          // Add the matchedCeleb's information: name, image, compatiability score
          $("#matched-name-display").text(matchedCeleb.name);

          $("#matched-photo-display").attr("src", matchedCeleb.photo);

          $("#matched-photo-display").attr("alt", matchedCeleb.name);

          $("#matched-info-display").append(lowestSum);
        }

        // Run RenderModal function, pass through matchedCelebFriend
        renderModal(matchedCelebFriend);
      }
    });
  });
</script>
